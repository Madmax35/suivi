<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Suivi Followers Instagram - KX CHR</title>
<style>
  body {
    margin: 0; background: #121212; color: #ddd;
    font-family: Arial, sans-serif;
    display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px;
  }
  .container {
    max-width: 900px; width: 100%;
    background: #1e1e1e; border-radius: 15px; padding: 20px;
    box-shadow: 0 0 20px #666;
  }
  h1 { text-align: center; color: #ccc; margin-bottom: 20px; font-weight: normal; }
  .profile { width: 120px; height: 120px; border-radius: 50%; overflow: hidden; margin: 0 auto 20px; border: 3px solid #666; }
  .profile img { width: 100%; height: 100%; object-fit: cover; }
  .btn-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
  .btn {
    padding: 8px 18px; border-radius: 8px; background: #333; color: #ddd; border: none;
    font-weight: 600; cursor: pointer; transition: background 0.3s ease; user-select: none;
  }
  .btn.active, .btn:hover { background: #555; }
  #inputRow { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
  #followersInput { width: 150px; padding: 10px; border-radius: 8px; border: none; font-size: 16px; color: #222; outline: none; }
  #addFollowerBtn { width: 90px; background: #444; color: #ddd; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: background 0.3s ease; }
  #addFollowerBtn:hover { background: #666; }
  #toolsRow { display:flex; justify-content:center; gap:10px; margin-bottom: 10px; }
  #followersHistory {
    margin-top: 10px; max-height: 160px; overflow-y: auto; border: 1px solid #444; border-radius: 8px; padding: 10px;
    background: #222; font-size: 14px; color: #ccc;
  }
  #followersHistory li { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #333; }
  #followersHistory li:last-child { border-bottom: none; }
  /* Nouveau : rangée export centrée sous l'historique */
  #exportRow { display:flex; justify-content:center; margin-top: 10px; }
  canvas { display: block; width: 100%; max-height: 350px; margin-top: 20px; }
  .stats { margin-top: 15px; font-weight: bold; font-size: 16px; color: #bbb; text-align: center; }
  .hint { text-align:center; font-size:12px; color:#888; margin-top:6px; }
</style>
</head>
<body>
  <div class="container">
    <h1>KX CHR Followers Instagram</h1>
    <div class="profile"><img src="profile.jpg" alt="KX CHR Profile" /></div>

    <div class="btn-group">
      <button class="btn active" data-range="7">1 semaine</button>
      <button class="btn" data-range="30">1 mois</button>
      <button class="btn" data-range="365">1 an</button>
    </div>

    <div id="inputRow">
      <input id="followersInput" type="number" placeholder="Nombre d'abonnés" />
      <button id="addFollowerBtn">Ajouter</button>
    </div>
    <div id="toolsRow">
      <button class="btn" id="resetBtn" title="Effacer les données sauvegardées (localStorage)">Réinitialiser</button>
    </div>

    <ul id="followersHistory"></ul>

    <!-- Nouveau : bouton Export CSV centré sous l'historique -->
    <div id="exportRow">
      <button class="btn" id="exportCsvBtn">Exporter en CSV</button>
    </div>

    <canvas id="followersChart"></canvas>
    <div class="stats" id="statsContainer"></div>
    <div class="hint">Les données sont stockées automatiquement dans votre navigateur (localStorage).</div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const STORAGE_KEY = "kxchr_followers_v1";

const DEFAULT_DATA = [
  { date: "2025-05-10", followers: 24000 },
  { date: "2025-06-01", followers: 29000 },
  { date: "2025-07-01", followers: 35300 },
  { date: "2025-07-28", followers: 35300 },
  { date: "2025-08-04", followers: 36700 },
  { date: "2025-08-05", followers: 36983 },
  { date: "2025-08-06", followers: 37267 },
  { date: "2025-08-07", followers: 37550 },
  { date: "2025-08-08", followers: 37750 },
  { date: "2025-08-09", followers: 37706 },
  { date: "2025-08-10", followers: 37817 }
];

let followersData = [];
let currentRange = 365;

// --- Persistance ---
function loadFollowersData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [...DEFAULT_DATA];
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [...DEFAULT_DATA];
    return parsed
      .filter(d => d && typeof d.date === "string" && typeof d.followers === "number")
      .sort((a, b) => new Date(a.date) - new Date(b.date));
  } catch (e) {
    console.warn("Impossible de charger les données, utilisation des valeurs par défaut.", e);
    return [...DEFAULT_DATA];
  }
}

function saveFollowersData() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(followersData));
  } catch (e) {
    alert("Sauvegarde impossible (quota navigateur ?). Les nouvelles données ne seront pas mémorisées.");
    console.error(e);
  }
}

window.addEventListener("storage", (e) => {
  if (e.key === STORAGE_KEY) {
    followersData = loadFollowersData();
    updateHistory(); updateChart(); updateStats();
  }
});

// --- UI/Calculs ---
function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("fr-FR", { day: "2-digit", month: "2-digit", year: "2-digit" });
}

function filterByRange(data, days) {
  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(endDate.getDate() - days);
  return data.filter(d => {
    const dt = new Date(d.date);
    return dt >= startDate && dt <= endDate;
  });
}

function updateHistory() {
  const ul = document.getElementById("followersHistory");
  ul.innerHTML = "";
  const filteredData = filterByRange(followersData, currentRange);
  filteredData.slice().reverse().forEach(entry => {
    const li = document.createElement("li");
    li.textContent = formatDate(entry.date);
    const span = document.createElement("span");
    span.textContent = entry.followers.toLocaleString("fr-FR");
    li.appendChild(span);
    ul.appendChild(li);
  });
}

const ctx = document.getElementById("followersChart").getContext("2d");
let chart;

function updateChart() {
  if (chart) chart.destroy();
  const filteredData = filterByRange(followersData, currentRange);
  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: filteredData.map(d => formatDate(d.date)),
      datasets: [{
        label: "Followers",
        data: filteredData.map(d => d.followers),
        borderColor: "#ddd",
        backgroundColor: "rgba(221, 221, 221, 0.3)",
        fill: true,
        tension: 0.3,
        borderWidth: 3,
        pointRadius: 4,
        pointHoverRadius: 6,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { color: "#aaa" }, grid: { color: "rgba(255,255,255,0.05)" } },
        y: { ticks: { color: "#aaa" }, grid: { color: "rgba(255,255,255,0.1)" } }
      }
    }
  });
}

function calculateStats() {
  const filteredData = filterByRange(followersData, currentRange);
  if (filteredData.length < 2) return { gain: 0 };
  return { gain: filteredData[filteredData.length - 1].followers - filteredData[0].followers };
}

function updateStats() {
  const stats = calculateStats();
  const container = document.getElementById("statsContainer");
  container.innerHTML = `<div>Gain total abonnés sur la période : <strong>${stats.gain.toLocaleString("fr-FR")}</strong></div>`;
}

// --- Export CSV ---
function exportCSV() {
  // Tri par date ascendante pour l’export
  const rows = [...followersData].sort((a, b) => new Date(a.date) - new Date(b.date));

  const header = "date,followers";
  const body = rows.map(r => `${r.date},${r.followers}`).join("\n");
  const csv = header + "\n" + body;

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  // Nom de fichier : kxchr_followers_YYYY-MM-DD.csv
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, "0");
  const dd = String(today.getDate()).padStart(2, "0");
  const filename = `kxchr_followers_${yyyy}-${mm}-${dd}.csv`;

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// --- Events ---
document.querySelectorAll(".btn-group .btn").forEach(btn => {
  btn.addEventListener("click", e => {
    document.querySelectorAll(".btn-group .btn").forEach(b => b.classList.remove("active"));
    e.target.classList.add("active");
    currentRange = parseInt(e.target.dataset.range);
    updateHistory(); updateChart(); updateStats();
  });
});

document.getElementById("addFollowerBtn").addEventListener("click", () => {
  const input = document.getElementById("followersInput");
  const val = parseInt(input.value);
  if (isNaN(val) || val <= 0) {
    alert("Merci d'entrer un nombre valide.");
    return;
  }
  const todayStr = new Date().toISOString().slice(0, 10);
  const existingIndex = followersData.findIndex(d => d.date === todayStr);
  if (existingIndex !== -1) {
    followersData[existingIndex].followers = val;
  } else {
    followersData.push({ date: todayStr, followers: val });
  }
  followersData.sort((a, b) => new Date(a.date) - new Date(b.date));
  saveFollowersData();
  updateHistory(); updateChart(); updateStats();
  input.value = "";
});

document.getElementById("resetBtn").addEventListener("click", () => {
  if (confirm("Effacer les données sauvegardées ?")) {
    localStorage.removeItem(STORAGE_KEY);
    followersData = loadFollowersData();
    updateHistory(); updateChart(); updateStats();
  }
});

document.getElementById("exportCsvBtn").addEventListener("click", exportCSV);

// --- Init ---
window.onload = () => {
  followersData = loadFollowersData();
  updateHistory(); updateChart(); updateStats();
};
</script>
</body>
</html>
