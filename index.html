<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Suivi Followers KX CHR</title>
<style>
  body {
    background-color: #121212;
    color: #ddd;
    font-family: Arial, sans-serif;
    margin: 0; padding: 20px;
  }
  input, button {
    font-size: 1rem;
    padding: 0.5em;
    margin: 0.5em 0;
    border-radius: 5px;
    border: none;
  }
  input {
    width: 250px;
    background: #222;
    color: #eee;
  }
  button {
    background-color: #444;
    color: #eee;
    cursor: pointer;
  }
  button:hover {
    background-color: #666;
  }
  table {
    width: 100%;
    margin-top: 1em;
    border-collapse: collapse;
  }
  td, th {
    padding: 8px;
    border-bottom: 1px solid #444;
  }
  #chartContainer {
    margin-top: 2em;
  }
</style>
</head>
<body>

<h1>Suivi Followers KX CHR</h1>

<input type="number" id="newFollowers" placeholder="Nombre d'abonnés aujourd'hui" />
<button id="addBtn">Ajouter</button>

<table id="historyTable">
  <thead>
    <tr><th>Date</th><th>Followers</th></tr>
  </thead>
  <tbody>
  </tbody>
</table>

<div id="chartContainer">
  <canvas id="followersChart" width="800" height="400"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Données initiales (extraites de tes infos passées, triées par date croissante)
  let data = [
    {date: '2025-05-10', followers: 24000},
    {date: '2025-06-01', followers: 29000},
    {date: '2025-07-01', followers: 35300},
    {date: '2025-07-28', followers: 35300},
    {date: '2025-08-04', followers: 36700},
    {date: '2025-08-05', followers: 36983},
    {date: '2025-08-06', followers: 37267},
    {date: '2025-08-07', followers: 37550},
    {date: '2025-08-08', followers: 37750},
    {date: '2025-08-09', followers: 37706}, // un peu en baisse (ok)
    {date: '2025-08-10', followers: 37817}
  ];

  // Fonction pour filtrer les valeurs aberrantes
  function filterData(rawData) {
    const filtered = [];
    for (let i=0; i<rawData.length; i++) {
      if (i === 0) {
        filtered.push(rawData[i]);
      } else {
        const diff = Math.abs(rawData[i].followers - rawData[i-1].followers);
        if (diff < 1000) { // seuil d'écart maximal autorisé (à ajuster)
          filtered.push(rawData[i]);
        } else {
          console.warn('Valeur ignorée (écart trop grand):', rawData[i]);
        }
      }
    }
    return filtered;
  }

  data = filterData(data);

  const ctx = document.getElementById('followersChart').getContext('2d');

  let chart;

  function updateChart() {
    const labels = data.map(d => d.date);
    const followers = data.map(d => d.followers);

    if (chart) {
      chart.destroy();
    }

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Followers',
          data: followers,
          borderColor: '#ddd',
          backgroundColor: 'rgba(221,221,221,0.2)',
          fill: true,
          tension: 0.3,
          pointRadius: 4,
          pointHoverRadius: 6,
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { display: true, title: {display: true, text: 'Date'} },
          y: { display: true, title: {display: true, text: 'Nombre d\'abonnés'} }
        }
      }
    });
  }

  function addEntry(followers) {
    const today = new Date().toISOString().split('T')[0];
    const last = data[data.length - 1];
    if (last && last.date === today) {
      data[data.length - 1].followers = followers;
    } else {
      data.push({date: today, followers});
    }
    data = filterData(data);
    updateHistory();
    updateChart();
  }

  function updateHistory() {
    const tbody = document.querySelector('#historyTable tbody');
    tbody.innerHTML = '';
    for (const entry of data.slice().reverse()) { // afficher du plus récent au plus ancien
      const tr = document.createElement('tr');
      const tdDate = document.createElement('td');
      tdDate.textContent = entry.date;
      const tdFollow = document.createElement('td');
      tdFollow.textContent = entry.followers;
      tr.appendChild(tdDate);
      tr.appendChild(tdFollow);
      tbody.appendChild(tr);
    }
  }

  document.getElementById('addBtn').addEventListener('click', () => {
    const input = document.getElementById('newFollowers');
    const val = parseInt(input.value, 10);
    if (isNaN(val) || val <= 0) {
      alert('Merci de saisir un nombre valide.');
      return;
    }
    addEntry(val);
    input.value = '';
  });

  // Initialisation
  updateHistory();
  updateChart();

</script>
</body>
</html>
